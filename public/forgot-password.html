<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Reset your HealthCard account password securely using email verification." />
    <meta name="keywords" content="HealthCard forgot password, reset healthcard password, account recovery" />
    <meta name="robots" content="index, follow" />
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="HealthCard" />
    <meta property="og:title" content="Forgot Password | HealthCard" />
    <meta property="og:description" content="Recover HealthCard access with secure email code verification." />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Forgot Password | HealthCard" />
    <meta name="twitter:description" content="Securely reset your HealthCard account password." />
    <link rel="icon" type="image/svg+xml" href="./favicon.svg" />
    <link rel="shortcut icon" href="./favicon.svg" />
    <title>Forgot Password | HealthCard</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-slate-950 text-slate-100 min-h-screen">
    <header class="p-6">
      <div class="mx-auto flex max-w-7xl items-center justify-between">
        <a href="./index.html" class="flex items-center gap-3 hover:opacity-80 transition">
          <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-emerald-500 text-slate-950 font-bold">HC</div>
          <span class="text-lg font-semibold tracking-tight">HealthCard</span>
        </a>
        <a href="./index.html" class="text-sm text-slate-300 hover:text-emerald-300">Back to Login</a>
      </div>
    </header>

    <main class="mx-auto max-w-xl px-6 pb-16">
      <section class="rounded-3xl border border-white/10 bg-slate-900 p-8 shadow-2xl">
        <p class="text-sm uppercase tracking-widest text-emerald-300">Account Recovery</p>
        <h1 class="mt-2 text-2xl font-semibold text-white">Forgot Password</h1>
        <p class="mt-2 text-sm text-slate-400">Enter email, verify reset code, then set a new password.</p>

        <div class="mt-6 flex items-center gap-2 text-xs">
          <span id="stepBadge1" class="rounded-full bg-emerald-400/20 px-3 py-1 text-emerald-200">1. Email</span>
          <span id="stepBadge2" class="rounded-full bg-white/10 px-3 py-1 text-slate-300">2. Verify code</span>
          <span id="stepBadge3" class="rounded-full bg-white/10 px-3 py-1 text-slate-300">3. New password</span>
        </div>

        <div id="statusBox" class="mt-6 hidden rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-sm"></div>

        <form id="requestForm" class="mt-6 space-y-4">
          <div>
            <label class="text-sm text-slate-200" for="email">Email</label>
            <input id="email" type="email" inputmode="email" autocomplete="email" required pattern="^[^\s@]+@[^\s@]+\.[^\s@]+$" placeholder="you@clinic.com" class="mt-2 w-full rounded-xl border border-white/10 bg-slate-950/60 px-4 py-3 text-sm text-white placeholder:text-slate-500 focus:border-emerald-400 focus:outline-none" />
          </div>
          <button type="submit" class="w-full rounded-xl bg-emerald-400 px-4 py-3 text-sm font-semibold text-slate-950 hover:bg-emerald-300 transition">Send Code</button>
        </form>

        <form id="verifyForm" class="mt-6 hidden space-y-4">
          <div>
            <label class="text-sm text-slate-200" for="code">Verification Code</label>
            <input id="code" type="text" inputmode="numeric" required minlength="6" maxlength="6" pattern="[0-9]{6}" placeholder="6-digit code" class="mt-2 w-full rounded-xl border border-white/10 bg-slate-950/60 px-4 py-3 text-sm tracking-[0.3em] text-white placeholder:text-slate-500 focus:border-emerald-400 focus:outline-none" />
          </div>
          <button type="submit" class="w-full rounded-xl bg-emerald-400 px-4 py-3 text-sm font-semibold text-slate-950 hover:bg-emerald-300 transition">Verify Code</button>
        </form>

        <form id="resetForm" class="mt-6 hidden space-y-4">
          <div>
            <label class="text-sm text-slate-200" for="newPassword">New Password</label>
            <input id="newPassword" type="password" autocomplete="new-password" required minlength="6" maxlength="72" placeholder="At least 6 characters" class="mt-2 w-full rounded-xl border border-white/10 bg-slate-950/60 px-4 py-3 text-sm text-white placeholder:text-slate-500 focus:border-emerald-400 focus:outline-none" />
          </div>
          <div>
            <label class="text-sm text-slate-200" for="confirmPassword">Confirm Password</label>
            <input id="confirmPassword" type="password" autocomplete="new-password" required minlength="6" maxlength="72" placeholder="Re-enter new password" class="mt-2 w-full rounded-xl border border-white/10 bg-slate-950/60 px-4 py-3 text-sm text-white placeholder:text-slate-500 focus:border-emerald-400 focus:outline-none" />
          </div>
          <button type="submit" class="w-full rounded-xl bg-emerald-400 px-4 py-3 text-sm font-semibold text-slate-950 hover:bg-emerald-300 transition">Update Password</button>
        </form>
      </section>
    </main>

    <script src="./assets/js/api.js?v=20260221b"></script>
    <script>
      window.__HC_USE_BACKEND_AUTH__ = true;
    </script>
    <script src="./assets/js/auth.js?v=20260221b"></script>
    <script>
      const requestForm = document.getElementById('requestForm');
      const verifyForm = document.getElementById('verifyForm');
      const resetForm = document.getElementById('resetForm');
      const statusBox = document.getElementById('statusBox');
      const emailInput = document.getElementById('email');
      const codeInput = document.getElementById('code');
      const newPasswordInput = document.getElementById('newPassword');
      const confirmPasswordInput = document.getElementById('confirmPassword');

      const stepBadge1 = document.getElementById('stepBadge1');
      const stepBadge2 = document.getElementById('stepBadge2');
      const stepBadge3 = document.getElementById('stepBadge3');

      let recoveryEmail = '';

      function setStep(step) {
        const activeClass = 'rounded-full bg-emerald-400/20 px-3 py-1 text-emerald-200';
        const inactiveClass = 'rounded-full bg-white/10 px-3 py-1 text-slate-300';

        stepBadge1.className = step >= 1 ? activeClass : inactiveClass;
        stepBadge2.className = step >= 2 ? activeClass : inactiveClass;
        stepBadge3.className = step >= 3 ? activeClass : inactiveClass;
      }

      function showStatus(message, isError = false) {
        statusBox.classList.remove('hidden');
        statusBox.className = `mt-6 rounded-xl border px-4 py-3 text-sm ${isError ? 'border-red-400/40 bg-red-500/10 text-red-100' : 'border-emerald-400/30 bg-emerald-500/10 text-emerald-100'}`;
        statusBox.textContent = message;
      }

      requestForm.addEventListener('submit', async function (event) {
        event.preventDefault();
        if (!requestForm.reportValidity()) {
          return;
        }

        const email = emailInput.value.trim().toLowerCase();
        const result = await requestPasswordReset(email);

        if (!result.success) {
          showStatus(result.message || 'Unable to send code', true);
          return;
        }

        recoveryEmail = email;
        showStatus('Code sent to your email.');

        requestForm.classList.add('hidden');
        verifyForm.classList.remove('hidden');
        setStep(2);
      });

      verifyForm.addEventListener('submit', async function (event) {
        event.preventDefault();
        if (!verifyForm.reportValidity()) {
          return;
        }

        const code = codeInput.value.trim();
        const result = await verifyResetCode(recoveryEmail || emailInput.value.trim().toLowerCase(), code);

        if (!result.success) {
          showStatus(result.message || 'Invalid code', true);
          return;
        }

        showStatus('Code verified. Set your new password.');
        verifyForm.classList.add('hidden');
        resetForm.classList.remove('hidden');
        setStep(3);
      });

      resetForm.addEventListener('submit', async function (event) {
        event.preventDefault();
        if (!resetForm.reportValidity()) {
          return;
        }

        const password = newPasswordInput.value.trim();
        const confirmPassword = confirmPasswordInput.value.trim();

        if (password !== confirmPassword) {
          showStatus('Passwords do not match', true);
          return;
        }

        const result = await resetForgottenPassword(recoveryEmail || emailInput.value.trim().toLowerCase(), password);

        if (!result.success) {
          showStatus(result.message || 'Unable to reset password', true);
          return;
        }

        showStatus('Password updated successfully. Redirecting to login...');
        setTimeout(() => {
          window.location.href = './index.html';
        }, 1200);
      });
    </script>
  </body>
</html>
